import jsPDF from 'jspdf';
import 'jspdf-autotable';
import html2canvas from 'html2canvas';
import type { ExchangeData } from '../types';

// Augment jsPDF with the autoTable method
// FIX: Changed from an interface to a type intersection. This correctly combines
// the jsPDF class type with the additional autoTable method, resolving
// multiple errors where methods on the original jsPDF object were not found.
type jsPDFWithAutoTable = jsPDF & {
  autoTable: (options: any) => jsPDF;
};

const A4_WIDTH_MM = 210;
const A4_HEIGHT_MM = 297;
const CARD_WIDTH_IN = 4;
const CARD_HEIGHT_IN = 6;
const IN_TO_MM = 25.4;

const addPageWatermark = (pdf: jsPDF) => {
    const pageCount = (pdf.internal as any).getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(8);
        pdf.setTextColor(150);
        pdf.text(
            `Generated by SecretSantaMatch.com | Page ${i} of ${pageCount}`,
            pdf.internal.pageSize.getWidth() / 2,
            pdf.internal.pageSize.getHeight() - 5,
            { align: 'center' }
        );
    }
};

export const generateAllCardsPdf = async (exchangeData: ExchangeData): Promise<void> => {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const cardElements = document.querySelectorAll<HTMLDivElement>('.printable-card-container');

    if (cardElements.length === 0) {
        throw new Error("Could not find printable card elements. Ensure they are rendered on the page.");
    }
    
    for (let i = 0; i < cardElements.length; i++) {
        const element = cardElements[i];
        if (i > 0) {
            pdf.addPage();
        }
        
        const canvas = await html2canvas(element, {
            scale: 3, // Higher scale for better quality
            useCORS: true,
            allowTaint: true,
            backgroundColor: null, // Use transparent background
        });
        
        const imgData = canvas.toDataURL('image/png');
        
        const cardWidthMM = CARD_WIDTH_IN * IN_TO_MM;
        const cardHeightMM = CARD_HEIGHT_IN * IN_TO_MM;

        const x = (A4_WIDTH_MM - cardWidthMM) / 2;
        const y = (A4_HEIGHT_MM - cardHeightMM) / 2;

        pdf.addImage(imgData, 'PNG', x, y, cardWidthMM, cardHeightMM);
    }
    
    addPageWatermark(pdf);
    pdf.save('Secret_Santa_Cards.pdf');
};


export const generateMasterListPdf = (exchangeData: ExchangeData): void => {
    const pdf = new jsPDF() as jsPDFWithAutoTable;
    const matches = exchangeData.matches.map(m => ({
        giver: exchangeData.p.find(p => p.id === m.g)!,
        receiver: exchangeData.p.find(p => p.id === m.r)!,
    }));

    // Document Header
    pdf.setFontSize(22);
    pdf.setFont('helvetica', 'bold');
    pdf.text("Secret Santa Master List", pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'normal');
    const eventDetailsText = `Event Details: ${exchangeData.eventDetails || 'N/A'}`;
    const splitDetails = pdf.splitTextToSize(eventDetailsText, pdf.internal.pageSize.getWidth() - 28);
    pdf.text(splitDetails, 14, 30);
    
    let finalY = pdf.getTextDimensions(splitDetails).h + 30;

    matches.forEach((match, index) => {
        const { giver, receiver } = match;

        const tableBody = [
            ['Budget', receiver.budget],
            ['Interests', receiver.interests],
            ['Likes', receiver.likes],
            ['Dislikes', receiver.dislikes]
        ].filter(row => row[1] && row[1].trim() !== '') // Filter out rows with no data
         .map(row => [row[0], pdf.splitTextToSize(row[1] as string, 135)]); // Wrap text

        if (tableBody.length === 0) {
            tableBody.push(['Details', 'No additional details provided.']);
        }
        
        pdf.autoTable({
            startY: finalY + 8,
            head: [[{
                content: `${giver.name}  ->  ${receiver.name}`,
                styles: {
                    halign: 'center',
                    fillColor: '#c62828', // Primary red
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 12,
                }
            }]],
            body: tableBody,
            theme: 'grid',
            columnStyles: {
                0: {
                    fontStyle: 'bold',
                    cellWidth: 40,
                    fillColor: '#f8fafc',
                },
            },
            didDrawPage: (data) => {
                // This space is for content on new pages, footer is added at the end.
            }
        });
        finalY = (pdf as any).lastAutoTable.finalY;
    });

    addPageWatermark(pdf);
    pdf.save('Secret_Santa_Master_List.pdf');
};

export const generatePartyPackPdf = async (exchangeData: ExchangeData): Promise<void> => {
    const pdf = new jsPDF();
    pdf.setFontSize(22);
    pdf.text("Secret Santa Party Pack", 105, 20, { align: 'center' });
    pdf.setFontSize(12);
    pdf.text("Thank you for using SecretSantaMatch.com!", 105, 40, { align: 'center' });
    pdf.text("More fun party pack features coming soon.", 105, 50, { align: 'center' });
    
    addPageWatermark(pdf);
    pdf.save('Secret_Santa_Party_Pack.pdf');
};