// FIX: This file was corrupted. It has been restored with the necessary PDF generation functions.
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import html2canvas from 'html2canvas';
import type { ExchangeData, Match } from '../types';
import React from 'react';
import ReactDOM from 'react-dom/client';
import PrintableCard from '../components/PrintableCard';


const renderComponentToCanvas = async (element: HTMLElement): Promise<HTMLCanvasElement> => {
    // Add a small delay for images to load, especially for cross-origin images
    await new Promise(resolve => setTimeout(resolve, 500));
    return await html2canvas(element, {
        useCORS: true,
        allowTaint: true,
        scale: 2, // Higher scale for better quality
        backgroundColor: null,
    });
};

/**
 * Generates a multi-page PDF with one styled card for each participant using a robust off-screen rendering method.
 */
export const generateAllCardsPdf = async (exchangeData: ExchangeData): Promise<void> => {
    const { p: participants, matches: matchIds, ...styleData } = exchangeData;

    const matches: Match[] = matchIds.map(m => ({
        giver: participants.find(p => p.id === m.g)!,
        receiver: participants.find(p => p.id === m.r)!,
    })).filter(m => m.giver && m.receiver);
    
    if (matches.length === 0) {
        throw new Error("No matches found to generate cards.");
    }

    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'px',
        format: [600, 800] // A larger base size for better quality, maintaining 3:4 ratio
    });

    // Hide the first page generated by default
    doc.deletePage(1);

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '-9999px';
    tempContainer.style.width = '600px'; // Match the PDF width for consistent rendering
    tempContainer.style.height = '800px';
    document.body.appendChild(tempContainer);

    const root = ReactDOM.createRoot(tempContainer);

    try {
        for (const match of matches) {
            await new Promise<void>(resolve => {
                root.render(
                    React.createElement(PrintableCard, {
                        match,
                        eventDetails: styleData.eventDetails,
                        isNameRevealed: true,
                        backgroundOptions: styleData.backgroundOptions,
                        bgId: styleData.bgId,
                        bgImg: styleData.customBackground,
                        txtColor: styleData.textColor,
                        outline: styleData.useTextOutline,
                        outColor: styleData.outlineColor,
                        outSize: styleData.outlineSize,
                        fontSize: styleData.fontSizeSetting,
                        font: styleData.fontTheme,
                        line: styleData.lineSpacing,
                        greet: styleData.greetingText,
                        intro: styleData.introText,
                        wish: styleData.wishlistLabelText,
                    })
                );
                
                // Allow time for React to render and for images to load
                setTimeout(async () => {
                    const cardElement = tempContainer.firstChild as HTMLElement;
                    if (cardElement) {
                        try {
                            const canvas = await renderComponentToCanvas(cardElement);
                            const imgData = canvas.toDataURL('image/png');
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, 0, 600, 800);
                        } catch (e) {
                             console.error("Error capturing card canvas:", e);
                             // We'll continue to the next card
                        }
                    } else {
                        console.error(`Could not find rendered card for ${match.giver.name}`);
                    }
                    resolve();
                }, 700); // Increased delay to ensure images are loaded
            });
        }
    } finally {
        // GUARANTEED CLEANUP
        root.unmount();
        document.body.removeChild(tempContainer);
    }

    if (doc.getNumberOfPages() === 0) {
        throw new Error("Failed to generate any cards for the PDF. Please check for errors in the console.");
    }

    doc.save('Secret_Santa_Cards.pdf');
};


/**
 * Generates a detailed, table-formatted master list of all matches for the organizer.
 */
export const generateMasterListPdf = (exchangeData: ExchangeData): void => {
    const { p: participants, matches: matchIds, eventDetails, exchangeDate, exchangeTime } = exchangeData;
    
    const matches: Match[] = matchIds.map(m => ({
        giver: participants.find(p => p.id === m.g)!,
        receiver: participants.find(p => p.id === m.r)!,
    })).filter(m => m.giver && m.receiver);

    const doc = new jsPDF();
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.text('Secret Santa - Master List', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

    if (eventDetails) {
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(`Event Details: ${eventDetails}`, 14, 35);
    }

    if (exchangeDate) {
        let dateInfo = `Exchange Date: ${exchangeDate}`;
        if (exchangeTime) dateInfo += ` at ${exchangeTime}`;
        doc.text(dateInfo, 14, 42);
    }
    
    const tableBody = matches.map(match => {
        const details = [];
        if (match.receiver.budget) details.push(`Budget: $${match.receiver.budget}`);
        if (match.receiver.interests) details.push(`Interests: ${match.receiver.interests}`);
        if (match.receiver.likes) details.push(`Likes: ${match.receiver.likes}`);
        if (match.receiver.dislikes) details.push(`Dislikes: ${match.receiver.dislikes}`);
        if (match.receiver.links) details.push(`Links: ${match.receiver.links}`);
        
        return [match.giver.name, match.receiver.name, details.join('\n')];
    });

    autoTable(doc, {
        startY: 50,
        head: [['Giver', 'Receiver', "Receiver's Wishlist & Details"]],
        body: tableBody,
        theme: 'striped',
        headStyles: { fillColor: [198, 40, 40] }, // A festive red
        columnStyles: {
            0: { cellWidth: 40 },
            1: { cellWidth: 40 },
            2: { cellWidth: 'auto' }
        },
        didParseCell: function (data) {
            if (data.column.index === 2) {
                data.cell.styles.fontStyle = 'normal';
                data.cell.styles.fontSize = 8;
            }
        }
    });

    const finalY = (doc as any).lastAutoTable.finalY || doc.internal.pageSize.getHeight() - 20;
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.getWidth();
    let footerY = finalY + 20;

    // Ensure footer is on the page, even if the table is long
    if (footerY > pageHeight - 10) {
        doc.addPage();
        footerY = 20;
    } else {
       footerY = pageHeight - 10;
    }


    doc.setFontSize(10);
    doc.setFont('helvetica', 'italic');
    doc.setTextColor(150);
    doc.text('Generated by SecretSantaMatch.com', pageWidth / 2, footerY, { align: 'center' });

    doc.save('Secret_Santa_Master_List.pdf');
};

/**
 * Generates a PDF party pack with fun extras like Bingo and Awards.
 */
export const generatePartyPackPdf = (exchangeData: ExchangeData): void => {
    const pdf = new jsPDF();

    // Page 1: Title
    pdf.setFontSize(22);
    pdf.text("Secret Santa Party Pack", 105, 20, { align: 'center' });
    pdf.setFontSize(12);
    pdf.text("Fun extras for your gift exchange!", 105, 30, { align: 'center' });
    pdf.text("Generated by SecretSantaMatch.com", 105, 38, { align: 'center' });

    // Page 2: Bingo
    pdf.addPage();
    pdf.setFontSize(18);
    pdf.text("Secret Santa Gift Bingo", 14, 22);
    pdf.setFontSize(10);
    pdf.text("During the gift exchange, cross off squares as gifts are opened. First to get 5 in a row wins!", 14, 30);
    
    // Draw a 5x5 grid
    const startX = 14;
    const startY = 40;
    const cellSize = 35;
    const bingoTerms = [
        "Something Red", "Socks", "Mug", "Coffee or Tea", "A Book",
        "Funny Gift", "Handmade Gift", "Gift Card", "Something Sweet", "A Candle",
        "Alcohol", "A Game", "FREE SPACE", "Something Cozy", "A Plant",
        "Tech Gadget", "Lotion/Soap", "Kitchen Item", "Something Local", "Regifted Item?",
        "Pet-related", "Experience Gift", "Clothing Item", "Picture Frame", "Something That Smells Good"
    ];

    pdf.setFontSize(9);
    for (let row = 0; row < 5; row++) {
        for (let col = 0; col < 5; col++) {
            const index = row * 5 + col;
            pdf.rect(startX + col * cellSize, startY + row * cellSize, cellSize, cellSize);
            // Split long text
            const textLines = pdf.splitTextToSize(bingoTerms[index], cellSize - 4);
            pdf.text(textLines, startX + col * cellSize + cellSize / 2, startY + row * cellSize + cellSize / 2, { align: 'center', baseline: 'middle' });
        }
    }
    
    // Page 3: Awards
    pdf.addPage();
    pdf.setFontSize(18);
    pdf.text("Secret Santa Party Awards", 14, 22);
    pdf.setFontSize(12);
    pdf.text("Vote for a winner in each category at the end of your party!", 14, 30);
    
    const awards = [
        "Most Thoughtful Gift",
        "Funniest Gift",
        "Most Creative Gift",
        "Best Wrapped Gift",
        "The 'Most Likely to Be Stolen' Award",
        "The 'What Is It?' Award"
    ];
    let awardY = 45;
    awards.forEach(award => {
        pdf.setFontSize(14);
        pdf.text(award, 14, awardY);
        pdf.setFontSize(10);
        pdf.text("Winner: _________________________________", 20, awardY + 8);
        awardY += 25;
    });

    pdf.save('Secret_Santa_Party_Pack.pdf');
};